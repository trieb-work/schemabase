datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["referentialActions"]
}

generator typegraphql {
  provider = "typegraphql-prisma"
}

// Visualize the schema
// https://github.com/notiz-dev/prisma-dbml-generator
// https://dbdiagram.io/d
generator dbml {
  provider = "prisma-dbml-generator"
}


model ProductDataFeed {
  id       String @id @default(uuid())
  // The public id used for lookups from incoming webhooks.
  publicId String @unique

  // Indicates if the integration is currently enabled.
  // The user might chose to disable it.
  enabled Boolean? @default(false)

  productDetailStorefrontURL String?
  tenant                     Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId                   String  @unique
}

model ZohoConfig {
  id String @id @default(uuid())

  // Indicates if the integration is currently enabled.
  // The user might chose to disable it.
  enabled             Boolean @default(false)
  // The public id used for lookups from incoming webhooks.
  publicId            String
  orgId               String
  clientId            String
  clientSecret        String
  payPalAccountId     String?
  creditCardAccountId String?
  webhookToken        String
  webhookID           String?
  customFunctionID    String?
  tenant              Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId            String  @unique
}



// Saleor Apps are separate applications that use GraphQL to talk to a Saleor
// server and receive webhooks with event notifications from Saleor.
// Every channel must have its own app
model SaleorApp {
  id          String @id
  channelSlug String
  domain      String @unique

  name String
  // The saleor application id
  // appId        String

  // Unlike regular users, Saleor Apps use a bearer token. The token is
  // assigned at App installation time and needs to be stored in a secure manner.
  // The authorization header for Apps has the following format:
  // Authorization: Bearer <app-token>
  appToken String

  // Every SaleorApp can have multiple webhooks configured.
  // This is not really necessary because a webhook can fire on multiple events
  // but let's be on the safe side.
  webhooks SaleorWebhook[]

  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId String

  @@unique([domain, channelSlug])
}

model SaleorWebhook {
  // Received from saleor when registering a webhook
  id String @id


  // The secret key used to create a hash signature with each payload.
  secretKey String

  // ID of the app to which the webhook belongs.
  saleorAppId String
  saleorApp   SaleorApp @relation(fields: [saleorAppId], references: [id], onDelete: Cascade)

}

// One tenant per company
// Every tenant can have multiple connections with every integration.
model Tenant {
  id String @id

  // Human readable identifier
  name String
  // customer data etc
  // metadata Metadata

  // Indicates if the integration is currently enabled.
  // The user might chose to disable it.
  enabled         Boolean               @default(false)
  // baseUrl         String
  saleorApps      SaleorApp[]
  zoho            ZohoConfig[]
  productdatafeed ProductDataFeed[]
  strapi Strapi[]
}


model Strapi{
  id          String @id

  name String
  webhooks StrapiWebhook[]

  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId String

}


model StrapiWebhook {
  id String @id

  // The sha512 hash of the authorization token
  tokenHash String

  // ID of the strapi instance to which the webhook belongs.
  strapiId String
  strapi   Strapi @relation(fields: [strapiId], references: [id], onDelete: Cascade)

}

